---
layout: page
title: NWS Area Forecast Discussion
---

<section id="discussions">
  <article id="discussion">
    <p>This page will display the Forecast Discussion from your local NWS Office based on your location</p>
  </article>
</section>

<script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>

<script>
  /*
   * Creates overlay and starts spinner
   * Implicity creates (or assigns to) overlay and spinner global vars
   */
  function startOverlay() {
    var opts = {
      scale: 2,
      color: '#fff',
      opacity: 0,
      trail: 100
    };
    spinner = new Spinner(opts).spin();

    overlay = document.createElement('div');
    overlay.id = 'overlay';
    overlay.style.width = '100vw';
    overlay.style.height = '100vh';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';

    overlay.style.backgroundColor = 'rgba(0, 0, 0, .75)';

    overlay.appendChild(spinner.el);
    document.body.appendChild(overlay);
  }


  /*
   * Stops spinner and removes overlay
   */
  function stopOverlay() {
    spinner.stop();
    document.body.removeChild(overlay);
  }


  var overlay;
  var spinner;

  if ("geolocation" in navigator) {
    startOverlay(); // initializes overlay and spinner
    console.log('geolocation is available');
    navigator.geolocation.getCurrentPosition(success, error, options);
  } else {
    console.log('geolocation IS NOT available');
  }

  function success(position) {
    console.log('Your current position is:' +
      '\nlatitude:  ' + position.coords.latitude +
      '\nlongitude: ' + position.coords.longitude +
      '\naccuracy:  ' + position.coords.accuracy + ' m' +
      '\naltitude:  ' + position.coords.altitude +
      ' +/- ' + position.coords.altitudeAccuracy +
      '\nheading:   ' + position.coords.heading +
      '\nspeed:     ' + position.coords.speed +
      '\ntimestamp: ' + position.timestamp);

    var latitude = position.coords.latitude;
    var longitude = position.coords.longitude;

    getStation(latitude, longitude)
      .then(cwa => {
        // Gets array of available local discussion products
        return getProducts('AFD', cwa);
      })
      .then(discussions => {
        // Gets content of most recent discussion product
        return getProduct(discussions);
      })
      .then(discussion => {
        var discussionsElement = document.getElementById("discussion");
        text = discussion.productText;
        text = text.split(/\n\n/);
        text[0] = text[0].replace(/\n/g, '<br>');
        text[1] = text[1].replace(/\n/g, '<br>');
        text = text.join('<br><br>');
        discussionsElement.innerHTML = text;
        stopOverlay();
      })
      .catch(err => {
        console.log('Fetch Error:', err);
      });
  };

  function error(err) {
    console.warn(`ERROR(${err.code}): ${err.message}`);
  };

  var options = {
    enableHighAccuracy: true, // default: false
    timeout: 5000, // default: Infinity
    maximumAge: 0 // default: 0
  };


  /*
   * Returns a promise for the NWS station
   */
  function getStation(latitude, longitude) {
    // console.log('Getting CWA at', latitude, ',', longitude, '...');
    let url = 'https://api.weather.gov/points/' + latitude + ',' + longitude;
    return fetch(url)
      .then(response => response.json())
      .then(json => json.properties.cwa)
      .catch(err => {
        console.log('Fetch Error:', err);
      });
  }


  /*
   * Returns a promise for a product available at office
   * @param {string} type
   * @param {string} office
   * @returns {Array.<Object>} features property of response in json format
   */
  function getProducts(type, office = '') {
    let url = 'https://api.weather.gov/products/types/' + type + '/locations/' + office;
    return fetch(url)
      .then(response => response.json())
      .then(json => json.features)
      .catch(err => {
        console.log('Fetch Error:', err)
      });
  }


  /*
   * Returns a promise for a discussion product, with index 0 being most recent
   * @param {Array.<Object>} features
   * @param (number) [i=0] array index to return 
   * @param {Object} json of product, note productText property
   */
  function getProduct(features, i = 0) {
    let url = features[i]['@id'];
    return fetch(url)
      .then(response => response.json())
      .catch(err => {
        console.log('Fetch Error:', err)
      });
  }
</script>
